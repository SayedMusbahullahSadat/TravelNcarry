<!-- templates/users/profile_detail.html -->
{% extends 'base.html' %}
{% load static %}
{% load user_filters %}


{% block title %}{{ profile_user.username }}'s Profile - TravelNCarry{% endblock %}

{% block extra_css %}
<style>
    .profile-header {
        background: linear-gradient(135deg, #4361ee 0%, #3a56d4 100%);
        border-radius: var(--border-radius);
        padding: 2rem;
        margin-bottom: 2rem;
        color: white;
        position: relative;
        overflow: hidden;
    }

    .profile-header::before {
        content: "";
        position: absolute;
        top: 0;
        right: 0;
        width: 300px;
        height: 300px;
        background-image: url("data:image/svg+xml,%3Csvg width='300' height='300' viewBox='0 0 300 300' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M30 30C11.2975 48.7025 0 73.2975 0 100C0 155.228 44.7715 200 100 200C126.702 200 151.298 188.703 170 170C188.703 151.298 200 126.702 200 100C200 73.2975 188.703 48.7025 170 30' stroke='rgba(255, 255, 255, 0.1)' stroke-width='2' fill='none'/%3E%3Cpath d='M270 130C251.297 148.703 226.702 160 200 160C144.772 160 100 115.228 100 60C100 33.2975 111.297 8.7025 130 -10' stroke='rgba(255, 255, 255, 0.05)' stroke-width='2' fill='none'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        opacity: 0.4;
    }

    .profile-info {
        display: flex;
        align-items: center;
        position: relative;
        z-index: 2;
    }

    .profile-avatar {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        background-color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 2rem;
        overflow: hidden;
        border: 4px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .profile-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .avatar-placeholder {
        font-size: 3rem;
        color: #6c757d;
    }

    .profile-details {
        flex: 1;
    }

    .profile-name {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    .profile-type {
        display: inline-block;
        background-color: rgba(255, 255, 255, 0.2);
        padding: 0.25rem 1rem;
        border-radius: 50px;
        font-size: 0.9rem;
        margin-bottom: 1rem;
    }

    .profile-stats {
        display: flex;
        gap: 2rem;
        margin-top: 1.5rem;
    }

    .stat-item {
        text-align: center;
    }

    .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
    }

    .stat-label {
        font-size: 0.8rem;
        opacity: 0.8;
    }

    .profile-card {
        border: none;
        border-radius: var(--border-radius);
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        height: auto;
        transition: var(--transition);
        margin-bottom: 2rem; /* Add proper spacing between cards */
        overflow: hidden; /* Prevent content overflow */
    }

    .profile-card .card-body {
        padding: 1.5rem;
        overflow: hidden; /* Prevent content overflow */
    }

    .profile-card .card-body::after {
        content: "";
        display: table;
        clear: both;
    }

    .profile-card:hover {
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
        transform: translateY(-5px);
    }

    .bio-section {
        line-height: 1.6;
    }

    .rating-item {
        padding: 1.5rem;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        transition: var(--transition);
        overflow: hidden; /* Prevent content overflow */
        clear: both; /* Ensure proper clearing */
    }

    .rating-item:last-child {
        border-bottom: none;
    }

    .rating-item:hover {
        background-color: rgba(0, 0, 0, 0.01);
    }

    .rating-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
        flex-wrap: wrap; /* Allow wrapping on small screens */
    }

    .rating-user {
        display: flex;
        align-items: center;
        margin-bottom: 0.5rem; /* Add spacing when wrapped */
    }

    .rating-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: #e9ecef;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 1rem;
        color: var(--dark-gray);
        font-weight: 600;
        font-size: 1rem;
        flex-shrink: 0; /* Prevent shrinking */
    }

    .rating-name {
        font-weight: 600;
    }

    .rating-stars {
        display: flex;
        align-items: center;
        margin-bottom: 0.25rem;
    }

    .rating-date {
        font-size: 0.8rem;
        color: #6c757d;
    }

    .rating-content {
        background-color: #f8f9fa;
        padding: 1rem;
        border-radius: var(--border-radius);
        font-style: italic;
        margin-top: 0.5rem;
        word-break: break-word; /* Prevent text overflow */
    }

    .verified-badge {
        display: inline-flex;
        align-items: center;
        background-color: rgba(76, 201, 240, 0.1);
        color: #4cc9f0;
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        margin-left: 0.5rem;
    }

    .profile-actions {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
        flex-wrap: wrap; /* Allow wrapping on small screens */
    }

    .profile-actions a {
        margin-bottom: 0.5rem; /* Add spacing when wrapped */
    }

    .indicator-badge {
        display: inline-flex;
        align-items: center;
        font-size: 0.8rem;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        margin-left: 0.5rem;
    }

    .indicator-badge.success {
        background-color: rgba(76, 175, 80, 0.1);
        color: #4caf50;
    }

    .indicator-badge.warning {
        background-color: rgba(255, 152, 0, 0.1);
        color: #ff9800;
    }

    .indicator-badge.danger {
        background-color: rgba(244, 67, 54, 0.1);
        color: #f44336;
    }

    .activity-timeline {
        position: relative;
        padding-left: 2rem;
    }

    .activity-timeline::before {
        content: "";
        position: absolute;
        left: 7px;
        top: 0;
        bottom: 0;
        width: 2px;
        background-color: #e9ecef;
    }

    .activity-item {
        position: relative;
        padding-bottom: 1.5rem;
    }

    .activity-item:last-child {
        padding-bottom: 0;
    }

    .activity-marker {
        position: absolute;
        left: -2rem;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background-color: var(--primary-color);
        top: 0;
    }

    .activity-date {
        font-size: 0.8rem;
        color: #6c757d;
        margin-bottom: 0.25rem;
    }

    .activity-title {
        font-weight: 600;
        margin-bottom: 0.25rem;
    }

    .activity-content {
        background-color: #f8f9fa;
        padding: 0.75rem;
        border-radius: var(--border-radius);
        font-size: 0.9rem;
    }

    .contact-info {
        display: flex;
        align-items: center;
        margin-bottom: 0.75rem;
    }

    .contact-icon {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background-color: rgba(67, 97, 238, 0.1);
        color: var(--primary-color);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 1rem;
        flex-shrink: 0; /* Prevent shrinking */
    }

    .contact-label {
        font-size: 0.8rem;
        color: #6c757d;
        margin-bottom: 0.25rem;
    }

    .contact-value {
        font-weight: 500;
    }

    .progress-bar {
        height: 6px;
        border-radius: 3px;
        margin-top: 0.5rem;
    }

    .progress {
        margin-bottom: 0.5rem; /* Add spacing between progress bars */
    }

    .no-ratings {
        text-align: center;
        padding: 2rem;
    }

    .no-ratings-icon {
        font-size: 3rem;
        color: #dee2e6;
        margin-bottom: 1rem;
    }

    .rating-list {
        overflow: hidden; /* Prevent content overflow */
    }

    /* Media queries for better responsive layout */
    @media (max-width: 768px) {
        .profile-info {
            flex-direction: column;
            text-align: center;
        }

        .profile-avatar {
            margin-right: 0;
            margin-bottom: 1.5rem;
        }

        .profile-stats {
            justify-content: center;
            flex-wrap: wrap;
        }

        .stat-item {
            flex: 0 0 45%;
            margin-bottom: 1rem;
        }

        .profile-actions {
            flex-direction: column;
            align-items: stretch;
        }

        .rating-breakdown .progress {
            margin-bottom: 1rem;
        }

        .rating-header {
            flex-direction: column;
        }

        .rating-user {
            margin-bottom: 0.75rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Profile Header -->
    <div class="profile-header animate__animated animate__fadeIn">
        <div class="profile-info">
            <div class="profile-avatar">
                {% if profile_user.profile_picture %}
                    <img src="{{ profile_user.profile_picture.url }}" alt="{{ profile_user.username }}" class="img-fluid">
                {% else %}
                    <div class="avatar-placeholder">
                        {{ profile_user.username|slice:":1" }}
                    </div>
                {% endif %}
            </div>
            <div class="profile-details">
                <div class="d-flex align-items-center flex-wrap">
                    <h1 class="profile-name mb-0">{{ profile_user.username }}</h1>
                    {% if profile_user.is_verified %}
                        <div class="verified-badge ms-2">
                            <i class="bi bi-patch-check-fill me-1"></i> Verified
                        </div>
                    {% endif %}
                    <div class="indicator-badge {% if profile_user.average_rating >= 4.5 %}success{% elif profile_user.average_rating >= 3.5 %}warning{% else %}danger{% endif %}">
                        <i class="bi bi-star-fill me-1"></i> {{ profile_user.average_rating|floatformat:1 }}/5.0
                    </div>
                </div>
                <div class="profile-type">{{ profile_user.get_user_type_display }}</div>

                {% if profile_user.phone_number or profile_user.address %}
                    <div class="mt-2">
                        {% if profile_user.phone_number %}
                            <span class="me-3"><i class="bi bi-telephone me-1"></i> {{ profile_user.phone_number }}</span>
                        {% endif %}
                        {% if profile_user.address %}
                            <span><i class="bi bi-geo-alt me-1"></i> {{ profile_user.address }}</span>
                        {% endif %}
                    </div>
                {% endif %}

                <div class="profile-actions">
                    {% if user.is_authenticated and user != profile_user %}
                        <a href="{% url 'start_conversation' user_id=profile_user.id %}" class="btn btn-light">
                            <i class="bi bi-chat-dots me-2"></i>Send Message
                        </a>
                        {% if profile_user.user_type == 'traveler' %}
                            <a href="{% url 'itinerary_list' %}?traveler={{ profile_user.id }}" class="btn btn-outline-light">
                                <i class="bi bi-calendar-check me-2"></i>View Itineraries
                            </a>
                        {% endif %}
                    {% elif user.is_authenticated and user == profile_user %}
                        <a href="{% url 'profile_update' %}" class="btn btn-light">
                            <i class="bi bi-pencil me-2"></i>Edit Profile
                        </a>
                        {% if user.user_type == 'traveler' %}
                            <a href="{% url 'my_itineraries' %}" class="btn btn-outline-light">
                                <i class="bi bi-calendar-check me-2"></i>My Itineraries
                            </a>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="profile-stats">
            <div class="stat-item">
                <div class="stat-value">{{ completed_trips }}</div>
                <div class="stat-label">{% if profile_user.user_type == 'traveler' %}Trips Completed{% else %}Packages Sent{% endif %}</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">{{ rating_count }}</div>
                <div class="stat-label">Ratings</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">{{ joined_days }}</div>
                <div class="stat-label">Days as Member</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">{{ response_rate }}%</div>
                <div class="stat-label">Response Rate</div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Left Column -->
        <div class="col-lg-4">
            <!-- About Section -->
            <div class="profile-card mb-4 animate__animated animate__fadeInUp">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-person me-2"></i>About</h5>
                </div>
                <div class="card-body">
                    <div class="bio-section">
                        {% if profile_user.bio %}
                            <p>{{ profile_user.bio }}</p>
                        {% else %}
                            <p class="text-muted">No bio available.</p>
                        {% endif %}
                    </div>

                    <hr>

                    <div>
                        <h6>Contact Information</h6>
                        <div class="contact-info">
                            <div class="contact-icon">
                                <i class="bi bi-envelope"></i>
                            </div>
                            <div>
                                <div class="contact-label">Email</div>
                                <div class="contact-value">{{ profile_user.email }}</div>
                            </div>
                        </div>

                        {% if profile_user.phone_number %}
                            <div class="contact-info">
                                <div class="contact-icon">
                                    <i class="bi bi-telephone"></i>
                                </div>
                                <div>
                                    <div class="contact-label">Phone</div>
                                    <div class="contact-value">{{ profile_user.phone_number }}</div>
                                </div>
                            </div>
                        {% endif %}

                        {% if profile_user.address %}
                            <div class="contact-info">
                                <div class="contact-icon">
                                    <i class="bi bi-geo-alt"></i>
                                </div>
                                <div>
                                    <div class="contact-label">Address</div>
                                    <div class="contact-value">{{ profile_user.address }}</div>
                                </div>
                            </div>
                        {% endif %}
                    </div>

                    <hr>

                    <div>
                        <h6>Member Since</h6>
                        <p>{{ profile_user.date_joined|date:"F j, Y" }}</p>
                    </div>
                </div>
            </div>

            <!-- Rating Breakdown Section -->
            <div class="profile-card mb-4 animate__animated animate__fadeInUp animate__delay-1s">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-bar-chart me-2"></i>Rating Breakdown</h5>
                </div>
                <div class="card-body">
                    {% for i in "54321" %}
                        <div class="d-flex align-items-center mb-2">
                            <div style="width: 40px;" class="text-end me-3">{{ i }} <i class="bi bi-star-fill text-warning"></i></div>
                            <div class="flex-grow-1">
                                <div class="progress">
                                    <div class="progress-bar bg-warning" role="progressbar"
                                         style="width: {% widthratio rating_breakdown|get_item:i|default:"0" rating_count|default:"1" 100 %}%;"
                                         aria-valuenow="{% widthratio rating_breakdown|get_item:i|default:"0" rating_count|default:"1" 100 %}"
                                         aria-valuemin="0"
                                         aria-valuemax="100">
                                    </div>
                                </div>
                            </div>
                            <div style="width: 40px;" class="text-start ms-3">
                                {{ rating_breakdown|get_item:i|default:"0" }}
                            </div>
                        </div>
                    {% endfor %}

                    <div class="text-center mt-4">
                        <h3 class="mb-0">{{ profile_user.average_rating|floatformat:1 }}</h3>
                        <div class="mb-2">
                            {% for i in "12345" %}
                                {% if forloop.counter <= profile_user.average_rating|floatformat:"0" %}
                                    <i class="bi bi-star-fill text-warning"></i>
                                {% elif forloop.counter <= profile_user.average_rating|add:"0.5"|floatformat:"0" %}
                                    <i class="bi bi-star-half text-warning"></i>
                                {% else %}
                                    <i class="bi bi-star text-warning"></i>
                                {% endif %}
                            {% endfor %}
                        </div>
                        <p class="text-muted">Based on {{ rating_count }} reviews</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div class="col-lg-8">
            <!-- Ratings & Reviews Section -->
            <div class="profile-card animate__animated animate__fadeInUp animate__delay-2s">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-star me-2"></i>Ratings & Reviews</h5>
                    {% if ratings.count > 5 %}
                        <button class="btn btn-sm btn-outline-primary" id="load-more-ratings">Show More</button>
                    {% endif %}
                </div>
                <div class="card-body p-0">
                    {% if ratings %}
                        <div class="rating-list">
                            {% for rating in ratings %}
                                <div class="rating-item animate__animated animate__fadeIn">
                                    <div class="rating-header">
                                        <div class="rating-user">
                                            <div class="rating-avatar">
                                                {% if rating.from_user.profile_picture %}
                                                    <img src="{{ rating.from_user.profile_picture.url }}" alt="{{ rating.from_user.username }}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                                                {% else %}
                                                    {{ rating.from_user.username|slice:":1" }}
                                                {% endif %}
                                            </div>
                                            <div>
                                                <div class="rating-name">{{ rating.from_user.username }}</div>
                                                <div class="rating-stars">
                                                    {% for i in "12345" %}
                                                        {% if forloop.counter <= rating.rating %}
                                                            <i class="bi bi-star-fill text-warning"></i>
                                                        {% else %}
                                                            <i class="bi bi-star text-warning"></i>
                                                        {% endif %}
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="rating-date">
                                            {{ rating.created_at|date:"F j, Y" }}
                                        </div>
                                    </div>
                                    {% if rating.comment %}
                                        <div class="rating-content">
                                            {{ rating.comment }}
                                        </div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="no-ratings">
                            <div class="no-ratings-icon">
                                <i class="bi bi-star"></i>
                            </div>
                            <h5>No Reviews Yet</h5>
                            <p class="text-muted">This user has not received any reviews yet.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Load more ratings functionality
        const loadMoreBtn = document.getElementById('load-more-ratings');
        const ratingItems = document.querySelectorAll('.rating-item');
        const initialVisibleCount = 5;

        if (loadMoreBtn && ratingItems.length > initialVisibleCount) {
            // Initially hide ratings beyond the visible count
            for (let i = initialVisibleCount; i < ratingItems.length; i++) {
                ratingItems[i].style.display = 'none';
            }

            loadMoreBtn.addEventListener('click', function() {
                // Show all hidden ratings
                for (let i = initialVisibleCount; i < ratingItems.length; i++) {
                    ratingItems[i].style.display = 'block';

                    // Add a slight delay to each item for a nice effect
                    setTimeout(() => {
                        ratingItems[i].classList.add('animate__fadeIn');
                    }, (i - initialVisibleCount) * 100);
                }

                // Hide the button
                loadMoreBtn.style.display = 'none';
            });
        }

        // Add animations to rating items when they come into view
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('animate__fadeIn');
                    observer.unobserve(entry.target);
                }
            });
        }, {
            threshold: 0.1
        });

        document.querySelectorAll('.rating-item').forEach(item => {
            observer.observe(item);
        });
    });
</script>
{% endblock %}