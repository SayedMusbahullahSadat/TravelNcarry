<!-- templates/users/profile_update.html -->
{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}Edit Profile - TravelNCarry{% endblock %}

{% block extra_css %}
<style>
    .profile-container {
        max-width: 800px;
        margin: 0 auto;
    }

    .profile-header {
        background: linear-gradient(135deg, #4361ee 0%, #3a56d4 100%);
        border-radius: var(--border-radius);
        padding: 1.5rem;
        margin-bottom: 2rem;
        color: white;
        position: relative;
        overflow: hidden;
    }

    .profile-header::before {
        content: "";
        position: absolute;
        top: 0;
        right: 0;
        width: 300px;
        height: 300px;
        background-image: url("data:image/svg+xml,%3Csvg width='300' height='300' viewBox='0 0 300 300' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M30 30C11.2975 48.7025 0 73.2975 0 100C0 155.228 44.7715 200 100 200C126.702 200 151.298 188.703 170 170C188.703 151.298 200 126.702 200 100C200 73.2975 188.703 48.7025 170 30' stroke='rgba(255, 255, 255, 0.1)' stroke-width='2' fill='none'/%3E%3Cpath d='M270 130C251.297 148.703 226.702 160 200 160C144.772 160 100 115.228 100 60C100 33.2975 111.297 8.7025 130 -10' stroke='rgba(255, 255, 255, 0.05)' stroke-width='2' fill='none'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        opacity: 0.4;
    }

    .profile-title {
        display: flex;
        align-items: center;
    }

    .profile-icon {
        width: 48px;
        height: 48px;
        background-color: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 1rem;
    }

    .profile-form-card {
        border: none;
        border-radius: var(--border-radius);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .form-section {
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        padding: 1.5rem;
    }

    .form-section:last-child {
        border-bottom: none;
    }

    .section-title {
        display: flex;
        align-items: center;
        margin-bottom: 1.5rem;
        font-size: 1.1rem;
        font-weight: 600;
    }

    .section-icon {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background-color: rgba(67, 97, 238, 0.1);
        color: var(--primary-color);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 1rem;
    }

    .avatar-preview {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        background-color: #e9ecef;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1.5rem;
        overflow: hidden;
        border: 3px solid var(--primary-color);
        position: relative;
    }

    .avatar-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .avatar-placeholder {
        font-size: 3rem;
        color: #6c757d;
    }

    .avatar-change {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: rgba(0, 0, 0, 0.5);
        color: white;
        text-align: center;
        padding: 0.25rem;
        font-size: 0.8rem;
        cursor: pointer;
        transition: var(--transition);
    }

    .avatar-change:hover {
        background-color: rgba(0, 0, 0, 0.7);
    }

    .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        padding: 1.5rem;
    }

    .privacy-note {
        background-color: rgba(76, 201, 240, 0.1);
        border-radius: var(--border-radius);
        padding: 1rem;
        margin-top: 1.5rem;
        display: flex;
        align-items: flex-start;
        gap: 1rem;
    }

    .privacy-icon {
        color: #4cc9f0;
        font-size: 1.5rem;
        line-height: 1;
    }

    .privacy-text {
        font-size: 0.9rem;
        color: #4d4d4d;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4 profile-container">
    <!-- Profile Header -->
    <div class="profile-header animate__animated animate__fadeIn">
        <div class="profile-title">
            <div class="profile-icon">
                <i class="bi bi-person-gear fs-4"></i>
            </div>
            <div>
                <h2 class="mb-0">Edit Your Profile</h2>
                <p class="mb-0">Update your personal information and preferences</p>
            </div>
        </div>
    </div>

    <div class="card profile-form-card animate__animated animate__fadeInUp">
        <form method="post" enctype="multipart/form-data" id="profile-form">
            {% csrf_token %}

            <!-- Profile Picture Section -->
            <div class="form-section text-center">
                <div class="section-title justify-content-center">
                    <div class="section-icon">
                        <i class="bi bi-camera"></i>
                    </div>
                    <span>Profile Picture</span>
                </div>

                <div class="avatar-preview">
                    {% if user.profile_picture %}
                        <img src="{{ user.profile_picture.url }}" alt="{{ user.username }}" id="avatar-image">
                    {% else %}
                        <div class="avatar-placeholder" id="avatar-placeholder">
                            {{ user.username|slice:":1" }}
                        </div>
                    {% endif %}
                    <div class="avatar-change" id="avatar-change">
                        <i class="bi bi-pencil-fill"></i> Change
                    </div>
                </div>

                <div class="d-none">
                    {{ form.profile_picture|as_crispy_field }}
                </div>

                <div class="mt-3">
                    <button type="button" class="btn btn-outline-danger btn-sm" id="remove-avatar">
                        <i class="bi bi-trash me-1"></i> Remove Picture
                    </button>
                </div>
            </div>

            <!-- Basic Information Section -->
            <div class="form-section">
                <div class="section-title">
                    <div class="section-icon">
                        <i class="bi bi-person"></i>
                    </div>
                    <span>Basic Information</span>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        {{ form.username|as_crispy_field }}
                    </div>
                    <div class="col-md-6 mb-3">
                        {{ form.email|as_crispy_field }}
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        {{ form.first_name|as_crispy_field }}
                    </div>
                    <div class="col-md-6 mb-3">
                        {{ form.last_name|as_crispy_field }}
                    </div>
                </div>

                <div class="privacy-note">
                    <div class="privacy-icon">
                        <i class="bi bi-shield-lock"></i>
                    </div>
                    <div class="privacy-text">
                        <strong>Privacy Note:</strong> Your email address is only visible to users you have ongoing transactions with. Your full name will be used for verification purposes only.
                    </div>
                </div>
            </div>

            <!-- Contact Information Section -->
            <div class="form-section">
                <div class="section-title">
                    <div class="section-icon">
                        <i class="bi bi-telephone"></i>
                    </div>
                    <span>Contact Information</span>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        {{ form.phone_number|as_crispy_field }}
                    </div>
                    <div class="col-md-6 mb-3">
                        {{ form.address|as_crispy_field }}
                    </div>
                </div>

                <div class="privacy-note">
                    <div class="privacy-icon">
                        <i class="bi bi-info-circle"></i>
                    </div>
                    <div class="privacy-text">
                        <strong>Contact Visibility:</strong> Your phone number will only be shared with users you're actively coordinating deliveries with. Your address is for shipping reference only.
                    </div>
                </div>
            </div>

            <!-- Bio Section -->
            <div class="form-section">
                <div class="section-title">
                    <div class="section-icon">
                        <i class="bi bi-file-text"></i>
                    </div>
                    <span>Bio</span>
                </div>

                {{ form.bio|as_crispy_field }}

                <p class="text-muted small">Tell other users about yourself. This will be displayed on your public profile. You may include information about your traveling habits, reliability, and experience.</p>
            </div>

            <!-- Password Section -->
            <div class="form-section">
                <div class="section-title">
                    <div class="section-icon">
                        <i class="bi bi-key"></i>
                    </div>
                    <span>Password</span>
                </div>

                <p>Need to update your password? <a href="{% url 'account_change_password' %}">Click here</a> to change your password.</p>
            </div>

            <!-- Form Actions -->
            <div class="form-actions">
                <a href="{% url 'profile_detail' pk=user.pk %}" class="btn btn-outline-secondary">
                    <i class="bi bi-x-circle me-2"></i>Cancel
                </a>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-circle me-2"></i>Save Changes
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const profilePictureInput = document.getElementById('id_profile_picture');
        const avatarChange = document.getElementById('avatar-change');
        const avatarImage = document.getElementById('avatar-image');
        const avatarPlaceholder = document.getElementById('avatar-placeholder');
        const removeAvatarBtn = document.getElementById('remove-avatar');

        // Handle avatar change click
        avatarChange.addEventListener('click', function() {
            profilePictureInput.click();
        });

        // Handle profile picture change
        profilePictureInput.addEventListener('change', function(e) {
            if (this.files && this.files[0]) {
                const reader = new FileReader();

                reader.onload = function(e) {
                    if (avatarImage) {
                        avatarImage.src = e.target.result;
                    } else {
                        // Create image if it doesn't exist
                        const avatarPreview = document.querySelector('.avatar-preview');
                        if (avatarPlaceholder) {
                            avatarPlaceholder.style.display = 'none';
                        }

                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.id = 'avatar-image';
                        img.alt = 'Profile Preview';

                        avatarPreview.prepend(img);
                    }
                }

                reader.readAsDataURL(this.files[0]);
            }
        });

        // Handle remove avatar button
        removeAvatarBtn.addEventListener('click', function() {
            // Clear the file input
            profilePictureInput.value = '';

            // Create a hidden input to signal deletion
            let deleteInput = document.getElementById('delete_profile_picture');
            if (!deleteInput) {
                deleteInput = document.createElement('input');
                deleteInput.type = 'hidden';
                deleteInput.name = 'delete_profile_picture';
                deleteInput.id = 'delete_profile_picture';
                deleteInput.value = 'true';
                document.getElementById('profile-form').appendChild(deleteInput);
            }

            // Update the preview
            if (avatarImage) {
                avatarImage.style.display = 'none';
            }

            if (avatarPlaceholder) {
                avatarPlaceholder.style.display = 'flex';
            } else {
                // Create placeholder if it doesn't exist
                const avatarPreview = document.querySelector('.avatar-preview');

                const placeholder = document.createElement('div');
                placeholder.className = 'avatar-placeholder';
                placeholder.id = 'avatar-placeholder';
                placeholder.textContent = '{{ user.username|slice:":1" }}';

                avatarPreview.prepend(placeholder);
            }
        });

        // Add animation to form sections
        const formSections = document.querySelectorAll('.form-section');
        formSections.forEach((section, index) => {
            section.classList.add('animate__animated', 'animate__fadeInUp');
            section.style.animationDelay = `${(index + 1) * 0.1}s`;
        });
    });
</script>
{% endblock %}